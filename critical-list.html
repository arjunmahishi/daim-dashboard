<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/resources/css/style.css">
</head>

<body id="bod" style="background: url(resources/images/background.png);">
    <script src="/resources/js/checktoken.js"></script>
    <ul id="slide-out" class="side-nav fixed">
        <li>
            <div class="user-view">
                <div class="background" style="background-color: #c0c0c0; ">
                </div>
            </li>
            <li>
                <a href="#!" id="sos-nav">SOS</a>
            </li>
            <li>
                <div class="divider"></div>
            </li>
            <li>
                <a href="#!" id="critical-list-nav">Critical List</a>
            </li>
            <li>
                <a href="#!" id="mdt-nav">MDT</a>
            </li>
            <li>
                <a href="#!" id="hdt-nav">HDT</a>
            </li>
            <li>
                <a href="#!" id="axel-nav">Axle</a>
            </li>
            <li>
                <a href="#!" id="casting-and-forging-nav">Casting and Forging</a>
            </li>
            <li>
                <a href="#!" id="transmission-nav">Transmission</a>
            </li>
            <li>
                <div class="divider"></div>
            </li>
            <li>
                <a class="subheader">Account</a>
            </li>
            <li>
                <a class="waves-effect" href="#!" id="logout-nav">Logout</a>
            </li>
        </ul>
        <!--Import jQuery before materialize.js-->
        <nav>
            <div class="nav-wrapper" style="background-color: #00677F;">
                <a href="index.html" class="brand-logo" style="margin-left: 12px;">Daimler</a>
                <a href="#" data-activates="slide-out" class="button-collapse">
                    <i class="material-icons">menu</i>
                </a>
            </div>
        </nav>
        <div id="sort-selection">
            <div class="card m12 s12" style="cursor: pointer; background-color: #00677F;">
                <div class="card-content white-text">
                    <div class="row" style="margin-bottom: 0px;">
                        <div class="col s3 m3">
                            <i class="material-icons prefix" style="margin-top: 5px;" id="prev">arrow_back</i>
                        </div>
                        <div class="col s6 m6">
                            <div>
                                <span class="card-title" style="text-align: center;" id="date">10/19/2017</span>
                            </div>
                        </div>
                        <div class="col s3 m3">
                            <i class="material-icons prefix" style="float: right; margin-top: 5px;" id="next">arrow_forward</i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col s12 m6" style="display: none;" id="sort-choices">
        <div class="card" style="background-color: #00677F;">
            <div class="card-content white-text">
                <div class="input-field col s6">
                    <i class="material-icons prefix">event</i>
                    <input type="text" class="datepicker date-color">
                    <label for="icon_prefix">Date</label>
                </div>
            </div>
            <button class="btn waves-effect waves-light" style="background-color: #1F778C;" id="apply-btn">
                <a href="#" style="color: white;">Apply</a>
            </button>
        </div>
    </div>
        <div>
            <div id="chartDiv" class="card" style="cursor: pointer; background-color: #00677F; margin-top: 10px;">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    <h4 class="sub-head" style="text-align: center; 
    margin-bottom: 0px;">CRITICAL PARTS</h4>
    <div class="container" id="card-cont">
        <div class="col s12 m6">
            <div class="card hoverable">

                <table class="table centered" id="table">
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Supplier Name</th>
                            <th>Part Name</th>
                            <th>Starred</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    <h4 class="sub-head" style="text-align: center;">PART TYPES</h4>
    <div class="container">
        <div class="row" style="margin-bottom: 0px;">
            <div class="col s12 m6" id="hdt">
                <div class="card white" style="cursor: pointer;">
                    <div class="card-content black-text">
                        <span class="card-title" style="text-align: center;">MDT</span>
                    </div>
                </div>
            </div>
            <div class="col s12 m6" id="hdt">
                <div class="card white" style="cursor: pointer;">
                    <div class="card-content black-text">
                        <span class="card-title" style="text-align: center;">HDT</span>
                    </div>
                </div>
            </div>
            <div class="col s12 m6" id="axle">
                <div class="card white" style="cursor: pointer;">
                    <div class="card-content black-text">
                        <span class="card-title" style="text-align: center;">Axle</span>
                    </div>
                </div>
            </div>
            <div class="col s12 m6" id="casting-and-forging">
                <div class="card white" style="cursor: pointer;">
                    <div class="card-content black-text">
                        <span class="card-title" style="text-align: center;">Casting and Forging</span>
                    </div>
                </div>
            </div>
            <div class="col s12 m6" id="transmission">
                <div class="card white" style="cursor: pointer;">
                    <div class="card-content black-text">
                        <span class="card-title" style="text-align: center;">Transmission</span>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="/resources/js/critical-list.js"></script>
        <script src="/resources/js/navbar.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
        <script>
            var url = "https://daimler-backend.herokuapp.com/api/parts/?ordering=-status";

            var data = [];
            var json;

            //global variable that holds a reference to the node that displays parts
            var tableRow;

            var token = sessionStorage.tokenid || "83cc351e4ec002a30f5fbe3e768cc4874263e9dd";

            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1;
            var yyyy = today.getFullYear();

            if (dd < 10) {
                dd = '0' + dd
            }

            if (mm < 10) {
                mm = '0' + mm
            }

            date = yyyy + '-' + mm + '-' + dd;

            var ctx = document.getElementById('myChart').getContext('2d');
            getData();


            $(function(){

                $('.datepicker').pickadate({
                selectMonths: true, // Creates a dropdown to control month
                selectYears: 15, // Creates a dropdown of 15 years to control year,
                today: 'Today',
                clear: 'Clear',
                close: 'Ok',
                closeOnSelect: true // Close upon selecting a date,
              });

                //For storing a reference to the node that displays parts
                  var tableContainer = document.getElementById('table');
                  var childNodes = tableContainer.children;
                  console.log(childNodes);

                   tableRow = childNodes[1].childNodes[1];


            //to select a date
            $('#sort-selection').click(function(){

              var sortsCard = document.getElementById('sort-choices');

              if($('#sort-choices').css('display') == 'none') {
                sortsCard.style.removeProperty('display');
                  console.log(sortsCard.children);

              }
              else{
                $('#sort-choices').css('display','none');

              }

              $('#apply-btn').click(function(){
                  sortsCard.setAttribute('style','display: none;');

                  var sortSelected = $('input[name=dates]:checked').next().text();
                  console.log(sortSelected);

                  var year = $('.datepicker').pickadate('picker').get('highlight', 'yyyy');
                  var month = $('.datepicker').pickadate('picker').get('highlight', 'mm');
                  var day = $('.datepicker').pickadate('picker').get('highlight', 'dd');
                  date = year + '-' + month + '-' + day;
                  sessionStorage.date = date;



                  getData();
              });
            });

            $('#next').click(function(e){
              var d= $('#date').text();
              dd= parseInt(d.substr(8,9));
              dd++;
              if(dd==31) dd=1;
              date = yyyy + '-' + mm + '-' + dd;

              getData();
              e.stopPropagation();
            });
            $('#prev').click(function(e){
              var d= $('#date').text();
              dd= parseInt(d.substr(8,9));

              dd--;
              if(dd==0) dd=31;
              date = yyyy + '-' + mm + '-' + dd;
              getData();
              e.stopPropagation();
            });
        });



            function getData() {
                fetch(url + "&short_on=" + date, {
                    method: "get",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Token ' + token
                    }
                }).then(function (response) {
                    if (response.ok) {
                        response.json().then(function (data) {
                            json = data;
                            console.log(json);
                            dataForChart(json);
                            addItems(json);
                            updateDisplay(json,date);

                        });
                    } else {
                        console.log('Network request failed with response ' + response.status + ': ' + response.statusText);
                    }
                });
            }

            function dataForChart(json) {
                var partnumber = [];
                var quantityAvailable = [];
                var plannedVehicleQuantity = [];
                var dicv = [];

                for (var i = 0; i < json.length; i++) {

                    if (i == 4) break;

                    for (var prop in json[i]) {
                        if (prop == 'part_number')
                            partnumber.push(json[i][prop]);

                        else if (prop === 'quantity')
                            quantityAvailable.push(json[i][prop]);

                        else if (prop === 'eta_dicv')
                            dicv.push(json[i][prop]);

                        else if (prop === 'planned_vehicle_qty')
                            plannedVehicleQuantity.push(json[i][prop]);


                    }
                    console.log(quantityAvailable);

                }
                var chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'bar',
                    scaleFontColor: '#fffffff',

                    // The data for our dataset
                    data: {
                        labels: partnumber,
                        datasets: [{
                            label: "Quantity Avl",
                            backgroundColor: 'rgb(210, 48, 48)',
                            borderColor: 'rgb(210, 48, 48)',
                            data: quantityAvailable,
                        },
                                   {
                                       label: "Planned Vehile Qty",
                                       backgroundColor: 'rgb(200, 200, 136)',
                                       borderColor: 'rgb(200, 200, 136)',
                                       data: plannedVehicleQuantity,
                                   },
                                  ],
                    },

                    // Configuration options go here
                    options: {
                        scaleFontColor: '#ffffff',
                        responsive: "true",
                        layout: {
                            padding: {
                                left: 20,
                                right: 20,
                                top: 10,
                                bottom: 10
                            }
                        },
                        legend: {
                            labels: {
                                fontColor: "#ffffff",
                            }
                        },

                        scales: {
                            xAxes: [{
                                ticks: {
                                    fontColor: "#ffffff",
                                }
                            }],
                            yAxes: [{
                                ticks: {
                                    fontColor: "#ffffff",
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
            }

            function updateDisplay(json, date) {

                $('#date').text(date);

                var container = document.getElementById('table');
                var children = container.children;
                var partContainer = children[1] //tbody
                var partDetails = partContainer.children;
                console.log(partDetails);

                if (json.length > 0) {

                    for (var i = 0; i < json.length; i++) {
                        console.log(String(i) + ' ' + json.length)
                        var j = 0;
                        for (var prop in json[i]) {

                            if (prop === "url") continue;

                            var parts = json[i];

                            //traverse the DOM and get the td cell
                            var cells = partDetails[i].children;

                            if (prop === 'part_number') {
                                cells[0].innerText = parts[prop];
                            } else if (prop === 'starred') {

                                if (parts[prop] === true) {
                                    cells[3].innerHTML =
                                        "<img src='resources/images/filled_star.png' id='image' onClick='editCell'>";
                                } else {
                                    cells[3].innerHTML =
                                        "<img src='resources/images/star2.png' id='image' onClick='editCell'>";
                                }
                            } else if (prop === 'supplier_name') {
                                cells[1].innerText = parts[prop];
                            } else if (prop === 'shop') {
                                cells[2].innerText = parts[prop];
                            } else if (prop === "status") {

                                if (parts[prop] === 3) {
                                    partDetails[i].setAttribute('class', 'red lighten-2');
                                } else if (parts[prop] === 2) {
                                    partDetails[i].setAttribute('class', 'yellow lighten-2');
                                } else {
                                    partDetails[i].setAttribute('class', 'green lighten-2');
                                }

                            }
                        }
                    }
                }
            }

            function addItems(list) {


                var tableContainer = document.getElementById('table');
                var childNodes = tableContainer.children;
                console.log(childNodes);

                var tableBody = childNodes[1];

                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }
                console.log(list.length);
                if (list.length > 0) {
                    for (var i = 0; i < list.length; i++) {
                        var newRow = tableRow.cloneNode(true);
                        var cells = newRow.children;
                        tableBody.appendChild(newRow);
                    }
                } else {

                    var newRow = tableRow.cloneNode(true);
                    tableBody.appendChild(newRow);

                }


            }
        </script>
        <script>
            $(document).ready(function () {
                $(".button-collapse").sideNav();
            });
            $('.button-collapse').sideNav({
                menuWidth: 230, // Default is 300
                edge: 'left', // Choose the horizontal origin
                closeOnClick: true, // Closes side-nav on <a> clicks, useful for Angular/Meteor
                draggable: true, // Choose whether you can drag to open on touch screens,

            });
        </script>
    </body>

</html>